<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  stroke: #ccc;
}

.node text {
  pointer-events: none;
  font: 10px sans-serif;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
}

// to convert seconds into hh:mm:ss
function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
}

// to dedpulicate an array
function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}


/* VARIABLES AND CONFIGURATION */

// variable containers for imported data
var charactersData,
  locationsData,
  locationsAltData,
  episodesData,
  charactersIncludeData,
  charactersGenderData,
  keyValue,
  keyValuesFile,
  episodeLengths,
  locations,
  subLocations,
  group,
  colors;


/* IMPORT DATA */
$.when(
  // $.getJSON("../data/characters.json", function(data) {
  //   charactersData = data.characters;
  //   console.log("characters.json loaded");
  // })
  // .fail(function() {console.error("characters.json not loaded");}),
      
  // $.getJSON("../data/locations.json", function(data) {
  //   locationsData = data.regions;
  //   console.log("locations.json loaded");
  // })
  // .fail(function() {console.error("locations.json not loaded");}),

  // $.getJSON("../data/locations-alt.json", function(data) {
  //   locationsAltData = data.sceneLocSorted;
  //   console.log("locations-alt.json loaded");
  // })
  // .fail(function() {console.error("locations-alt.json not loaded");}),

  $.getJSON("../data/episodes.json", function(data) {
    episodesData = data.episodes;
    console.log("episodes.json loaded");
  })
  .fail(function() {console.error("episodes.json not loaded");}),

  // $.getJSON("../data/characters-include.json", function(data) {
  //   charactersIncludeData = data.include;
  //   console.log("characters-include.json loaded");
  // })
  // .fail(function() {console.error("characters-include.json not loaded");}),

  // $.getJSON("../data/characters-gender.json", function(data) {
  //   charactersGenderData = data.gender;
  //   console.log("characters-gender.json loaded");
  // })
  // .fail(function() {console.error("characters-gender.json not loaded");}),

  // $.getJSON("../data/keyValues.json", function(data) {
  //   keyValues = data.keyValues;
  // episodeLengths = data.episodeLengths;
  //   locations = data.sceneLocSorted;
  //   subLocations = data.sceneSubLocSorted;
  //   console.log("keyValues.json loaded");
  // })
  // .fail(function() {console.error("keyValues.json not loaded");}),

  // $.getJSON("../data/characters-groups.json", function(data) {
  //   group = data.groups;
  //   console.log("characters-groups.json loaded");
  // })
  // .fail(function() {console.error("characters-groups.json not loaded");}),

  // $.getJSON("../data/colors.json", function(data) {
  //   colors = data.colors;
  //   console.log("colors.json loaded");
  // })
  // .fail(function() {console.error("colors.json not loaded");}),

  $.getJSON("../data/config.json", function(data) {
    config = data.config;
    console.log("config.json loaded");
  })
  .fail(function() {console.error("config.json not loaded");})


/* DO STUFF WITH THE DATA */

).then(function() {
  console.log("now that the files are loaded... do magic.");

  /* CONFIG SETUP */
  /* END CONFIG SETUP */

  var file, width, height;

  if(config.forceDirected.scopeMain){
    width = config.forceDirected.main.size;
    height = config.forceDirected.main.size;
    file = config.forceDirected.main.file;
  } else {
    width = config.forceDirected.all.size;
    height = config.forceDirected.all.size;
    file = config.forceDirected.all.file;
  }

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  var force = d3.layout.force()
      .gravity(0.5)
      .distance(30)
      .charge(-5000)
      .size([width, height]);

  d3.json("../data/"+file, function(error, json) {
    if (error) throw error;

    force
        .nodes(json.nodes)
        .links(json.links)
        .start();

    var link = svg.selectAll(".link")
        .data(json.links)
      .enter().append("line")
        .attr("class", "link");

    var node = svg.selectAll(".node")
        .data(json.nodes)
      .enter().append("g")
        .attr("class", "node")
        .call(force.drag);

    node.append("image")
        .attr("xlink:href", "https://github.com/favicon.ico")
        .attr("x", -8)
        .attr("y", -8)
        .attr("width", 16)
        .attr("height", 16);

    node.append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.name });

    force.on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    });
  });
});

</script>